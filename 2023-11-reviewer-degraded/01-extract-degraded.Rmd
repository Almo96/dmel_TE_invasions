---
title: "extract sequences of old-fragmented copies"
output: github_document
---


# which assemblies
```{bash eval=FALSE}
md5 *fasta                                                                                                                                    
MD5 (Canton-S.fasta) = 4b60ff2ee57267a22585bd86bb614781
MD5 (DGRP-732.fasta) = b1d5cc5a6a8f8e9be435d66d7b99b2e5
MD5 (Oregon-R.fasta) = 612e225c236129d9f6f15cc8ccd825b6
# check on my personal computer after sftp
MD5 (Canton-S.fasta) = 4b60ff2ee57267a22585bd86bb614781
MD5 (DGRP-732.fasta) = b1d5cc5a6a8f8e9be435d66d7b99b2e5
MD5 (Oregon-R.fasta) = 612e225c236129d9f6f15cc8ccd825b6
```




# Repeat Masking
```{bash eval=FALSE}
# done for the 2D heatmaps
for i in *.fa; do RepeatMasker -pa 20 -no_is -s -nolow -dir out -lib repeatlibrary/teseqs.fasta  $i;done  


# check ori.out of RepeatMasker in my folder after sftp
MD5 (Canton-S.fasta.ori.out) = efefc56d419e0a9bb4d31ad1ebd6a05e
MD5 (DGRP-732.fasta.ori.out) = c21d0ac87aaa2540bd1357bf3c327bf3
MD5 (Oregon-R.fasta.ori.out) = 429355e66e90acaf2ea9c113f68c62b7
```


Merge fragmented entries: merger

```{bash eval=FALSE}
[0,9658]rokofler%python rm-merger.py --fai raw-seq/teseqs.fasta.fai --dist 100 --rm raw-out/Canton-S.fasta.ori.out > raw-merged/Canton-S.merged
[0,9659]rokofler%python rm-merger.py --fai raw-seq/teseqs.fasta.fai --dist 100 --rm raw-out/Oregon-R.fasta.ori.out > raw-merged/Oregon-R.merged 
[0,9660]rokofler%python rm-merger.py --fai raw-seq/teseqs.fasta.fai --dist 100 --rm raw-out/DGRP-732.fasta.ori.out > raw-merged/DGRP-732.merged 

# head raw-merged/Canton-S.merged
# TE  chrm    strand start  end qstart  qend  divergence  qlen  telen
RT1C	X_RaGOO	+	1243825	1244687	1416	2978	10.6505542169	1563	5443
RT1C	X_RaGOO	+	20257895	20259126	3633	5442	11.8975162866	1810	5443
RT1C	X_RaGOO	+	20267696	20268986	3577	5442	11.8008641005	1866	5443
RT1C	X_RaGOO	+	20534849	20536607	2118	5441	6.8440880139	3324	5443
RT1C	X_RaGOO	+	20542524	20544260	2118	5443	6.88831460674	3326	5443
RT1C	X_RaGOO	+	20550157	20551886	2118	5443	6.64923668639	3326	5443
RT1C	X_RaGOO	+	20557756	20559482	2118	5443	6.65180794309	3326	5443
RT1C	X_RaGOO	+	20565436	20567161	2118	5441	6.59995848161	3324	5443
RT1C	X_RaGOO	+	21359755	21359787	4528	4560	3.03	33	5443
RT1C	X_RaGOO	+	21360095	21361153	1	5443	12.7008860759	5443	5443
```

# Visualize Canton-S

```{R}
library(tidyverse)
theme_set(theme_bw())

h<-read.table("/Users/rokofler/analysis/dmel_TE_invasions/2023-11-reviewer-degraded/raw-merged/Canton-S.merged",header=F)
names(h)<-c("te","chr","strand","start","end","qstart","qend","div","fraglen","telen")
h$lenfraction <- h$fraglen / h$telen
h<-subset(h,te %in% c("BLOOD","OPUS","412")) 

tp<-subset(h,fraglen>6000 & div <5)
p <- ggplot(tp, aes(x=div))+geom_histogram(bins=50)+facet_grid(.~te)
plot(p)

tp<-subset(h,fraglen>100 & div <5)
p <- ggplot(tp, aes(x=div))+geom_histogram(bins=50)+facet_grid(.~te)
plot(p)
```



Extract fragments
```{bash eval=FALSE}
cat Canton-S.merged |awk '$1=="OPUS" || $1=="BLOOD"|| $1=="412"' | awk '$8>1.5 && $9>100' > old-fragments-cantons
# generate - bed
cat old-fragments-cantons|awk 'BEGIN{OFS="\t"}{print $2,$4,$5,$1 "_" NR}' > old-fragments.bed
# extract sequences
reader-fasta.py raw-seq/Canton-S.fasta |fasta-subseq-fasta.py --bed raw-merged/old-fragments.bed |fasta-writter.py > old-fragments/Cantons-fragments.fasta
# get hierachy
cat raw-merged/old-fragments.bed|awk '{print $4 "\t" $4}'|perl -pe 's/_(\d)+$//' |awk '{print $1 "\t" $2 "_anc\tLTR" }' >old-fragments/Cantons-fragments.hier  
# in the hierachy, generate a distinct category for the special Blood
# cat Canton-S.merged|awk '$1=="BLOOD" && $8<5 && $8>1.5 && $9>6000'
#BLOOD	X_RaGOO	C	26018450	26025559	1	7269	2.40710796013	7269	7410
#BLOOD	3R_RaGOO	+	3235949	3242942	1	7129	1.91953728984	7129	7410
#BLOOD	3R_RaGOO	C	3191734	3198491	377	7267	1.66142347166	6891	7410
#BLOOD	3R_RaGOO	C	3417640	3424656	1	7267	2.1289491827	7267	7410

# X_RaGOO	26018450	26025559	BLOOD_197
# 3R_RaGOO	3235949	3242942	BLOOD_204
# 3R_RaGOO	3191734	3198491	BLOOD_208
# 3R_RaGOO	3417640	3424656	BLOOD_210
```

# Supplementary Figure - CantonS in more detail
```{R}
library(tidyverse)
theme_set(theme_bw())

h<-read.table("/Users/rokofler/analysis/dmel_TE_invasions/2023-11-reviewer-degraded/raw-merged/Canton-S.merged",header=F)
names(h)<-c("te","chr","strand","start","end","qstart","qend","div","fraglen","telen")
h$lenfraction <- h$fraglen / h$telen
h<-subset(h,te %in% c("BLOOD","OPUS","412")) 
tp<-subset(h,fraglen>100)
p <- ggplot(tp, aes(x=div))+geom_histogram(bins=80)+facet_grid(.~te)
plot(p)

pdf(file="/Users/rokofler/analysis/dmel_TE_invasions/2023-11-reviewer-degraded/graph/cans-hist.pdf",width=6,height=3)
plot(p)
dev.off()

tp<-subset(h,fraglen>100 & div <25 & div >1.5)
tp<-tp[order(tp$te, tp$fraglen,decreasing=TRUE),]
tp$id<-c(1:sum(tp$te=="OPUS"),1:sum(tp$te=="BLOOD"),1:sum(tp$te=="412"))

p<-ggplot(tp,aes(x = qstart, y = id, xend = qend, yend = id,color=div))+geom_segment(size=1)+facet_grid(.~te,scales="free_x")+xlab("position")+ylab("TE fragment")

plot(p)

pdf(file="/Users/rokofler/analysis/dmel_TE_invasions/2023-11-reviewer-degraded/graph/cans-line.pdf",width=6.5,height=4)
plot(p)
dev.off()
```



```{R}
h<-read.table("/Users/rokofler/analysis/dmel_TE_invasions/2023-11-reviewer-degraded/raw-merged/Canton-S.merged",header=F)
names(h)<-c("te","chr","strand","start","end","qstart","qend","div","fraglen","telen")
h$lenfraction <- h$fraglen / h$telen
h<-subset(h,te %in% c("BLOOD","OPUS","412")) 
tp<-subset(h,fraglen>100 & div <25 )
tp$fragtype="consensus"
tp[tp$div>1.5,]$fragtype="diverged"

tp$fragtype <- factor(tp$fragtype, levels=c("consensus","diverged"))
tp<-tp[order(tp$te, tp$fragtype, tp$fraglen,decreasing=TRUE),]


tp<-tp %>% group_by(te,fragtype) %>% mutate(id = row_number())
tp$id=-1*tp$id

p<-ggplot(tp,aes(x = qstart, y = id, xend = qend, yend = id,color=div))+
  geom_segment(size=1)+facet_grid(fragtype~te,scales="free",space="free")+
  xlab("position")+ylab("TE fragment")+
  theme(axis.text.y =element_blank(), axis.ticks.y =element_blank())+
  scale_colour_gradientn(
    colours = c("green","yellow","red")
)
plot(p)

pdf(file="/Users/rokofler/analysis/dmel_TE_invasions/2023-11-reviewer-degraded/graph/cans-line-all.pdf",width=7,height=5)
plot(p)
dev.off()
```

# manhatten plots
```{R}
h<-read.table("/Users/rokofler/analysis/dmel_TE_invasions/2023-11-reviewer-degraded/raw-merged/Canton-S.merged",header=F)
names(h)<-c("te","chr","strand","start","end","qstart","qend","div","fraglen","telen")
h$lenfraction <- h$fraglen / h$telen
h<-subset(h,te %in% c("BLOOD","OPUS","412")) 

h$chr<-recode_factor(h$chr, X_RaGOO="X","2L_RaGOO"="2L","2R_RaGOO"="2R", "3L_RaGOO"="3L","3R_RaGOO"="3R","4_RaGOO"="4") 
h$te<-recode_factor(h$te, BLOOD="Blood","OPUS"="Opus","412"="412") 
keeporder<-c("X","2L","2R", "3L","3R","4")
h<-subset(h,chr %in% keeporder)

tp<-subset(h,fraglen>100 & div <25  )
tp$fragtype="consensus"
tp[tp$div>1.5,]$fragtype="diverged"

p<-ggplot(tp,aes(x = start, y = 0, xend = start, yend = lenfraction,color=div))+
  geom_segment(size=1)+facet_grid(te+fragtype~chr,scales="free_x",space="free_x")+
 xlab("position")+ylab("length fraction of TE insertion [0-1]")+
  scale_colour_gradientn(colours = c("green","yellow","red"))+
  scale_x_continuous(breaks=c(0,10000000,20000000,30000000),
                     labels=c("0","10m","20m","30m"))+
  theme(legend.position = "none")+
  scale_y_continuous(breaks=c(0,0.5,1.0))

#)
plot(p)

pdf(file="/Users/rokofler/analysis/dmel_TE_invasions/2023-11-reviewer-degraded/graph/cans-mhp.pdf",width=7,height=5)
plot(p)
dev.off()


```




